{% extends "base.html" %} {% load static %} {% block title %}Submit Device ·
E-Waste Navigator{% endblock %} {% block content %}
<section class="bg-slate-50 transition-colors duration-300 dark:bg-slate-950">
  <div class="mx-auto max-w-4xl px-6 py-12">
    <h1
      class="text-3xl font-semibold text-slate-900 transition-colors dark:text-white"
    >
      Schedule a responsible drop-off
    </h1>
    <p
      class="mt-2 text-sm text-slate-600 transition-colors dark:text-slate-400"
    >
      Share your device details so the facility can prepare processing
      instructions and estimate your credit value.
    </p>

    <form
      id="device-submission-form"
      method="post"
      class="mt-8 space-y-6 rounded-3xl border border-slate-200 bg-white/95 p-8 shadow-xl shadow-slate-100 transition-colors dark:border-slate-800 dark:bg-slate-900/70 dark:shadow-slate-900/40"
    >
      {% csrf_token %} {{ form.device_type }}
      <div class="grid gap-6 md:grid-cols-2">
        <div class="md:col-span-2">
          <label
            class="inline-flex items-center gap-2 text-sm font-medium text-slate-700 transition-colors dark:text-slate-200"
            for="id_device_category"
          >
            <i class="fa-solid fa-layer-group"></i>
            Select a device type
          </label>
          <div
            class="mt-2 relative rounded-xl border border-slate-200 focus-within:border-sky-400 focus-within:ring-2 focus-within:ring-sky-200 transition-colors dark:border-slate-700 dark:focus-within:ring-0"
          >
            {{ form.device_category }}
          </div>
          {% if form.device_category.errors %}
          <p class="mt-2 text-xs text-rose-500">
            {{ form.device_category.errors|striptags }}
          </p>
          {% endif %}
        </div>

        <div class="md:col-span-2">
          <label
            class="inline-flex items-center gap-2 text-sm font-medium text-slate-700 transition-colors dark:text-slate-200"
            for="id_device_model"
          >
            <i class="fa-solid fa-database"></i>
            Choose a listed model
          </label>
          <div class="mt-2 relative rounded-xl border border-slate-200">
            {{ form.device_model }}
          </div>
          <p class="mt-2 text-xs text-slate-500">
            If your device is not in the list, leave this blank and describe it
            below.
          </p>
          {% if form.device_model.errors %}
          <p class="mt-2 text-xs text-rose-500">
            {{ form.device_model.errors|striptags }}
          </p>
          {% endif %}
        </div>
        <div class="md:col-span-2">
          <label
            class="inline-flex items-center gap-2 text-sm font-medium text-slate-700 transition-colors dark:text-slate-200"
            for="id_custom_device_type"
          >
            <i class="fa-solid fa-pen-to-square"></i>
            Or enter a custom type
          </label>
          <div
            class="mt-2 relative rounded-xl border border-slate-200 bg-white focus-within:border-sky-400 focus-within:ring-2 focus-within:ring-sky-200 transition-colors dark:border-slate-700 dark:bg-slate-900/60 dark:focus-within:ring-0"
          >
            {{ form.custom_device_type }}
          </div>
          {% if form.custom_device_type.errors %}
          <p class="mt-2 text-xs text-rose-500">
            {{ form.custom_device_type.errors|striptags }}
          </p>
          {% endif %}
        </div>
        <div class="md:col-span-2">
          <label
            class="inline-flex items-center gap-2 text-sm font-medium text-slate-700 transition-colors dark:text-slate-200"
            for="id_custom_device_name"
          >
            <i class="fa-solid fa-pen"></i>
            Device name / model number
          </label>
          <div
            class="mt-2 relative rounded-xl border border-slate-200 bg-white focus-within:border-sky-400 focus-within:ring-2 focus-within:ring-sky-200 transition-colors dark:border-slate-700 dark:bg-slate-900/60 dark:focus-within:ring-0"
          >
            {{ form.custom_device_name }}
          </div>
          {% if form.custom_device_name.errors %}
          <p class="mt-2 text-xs text-rose-500">
            {{ form.custom_device_name.errors|striptags }}
          </p>
          {% endif %}
        </div>
        <div>
          <label
            class="inline-flex items-center gap-2 text-sm font-medium text-slate-700 transition-colors dark:text-slate-200"
            for="id_drop_off_facility"
          >
            <i class="fa-solid fa-location-dot"></i>
            Preferred facility
          </label>
          <div
            class="mt-2 relative rounded-xl border border-slate-200 bg-white focus-within:border-sky-400 focus-within:ring-2 focus-within:ring-sky-200 transition-colors dark:border-slate-700 dark:bg-slate-900/60 dark:focus-within:ring-0"
          >
            {{ form.drop_off_facility }}
          </div>
          {% if form.drop_off_facility.errors %}
          <p class="mt-2 text-xs text-rose-500">
            {{ form.drop_off_facility.errors|striptags }}
          </p>
          {% endif %}
        </div>
        <div>
          <label
            class="inline-flex items-center gap-2 text-sm font-medium text-slate-700 transition-colors dark:text-slate-200"
            for="id_pickup_address"
          >
            <i class="fa-solid fa-truck"></i>
            Pickup address
          </label>
          <div
            class="mt-2 relative rounded-xl border border-slate-200 bg-white focus-within:border-sky-400 focus-within:ring-2 focus-within:ring-sky-200 transition-colors dark:border-slate-700 dark:bg-slate-900/60 dark:focus-within:ring-0"
          >
            {{ form.pickup_address }}
          </div>
          {% if form.pickup_address.errors %}
          <p class="mt-2 text-xs text-rose-500">
            {{ form.pickup_address.errors|striptags }}
          </p>
          {% endif %}
        </div>
        <div class="md:col-span-2">
          <div class="flex items-center justify-between">
            <label
              class="inline-flex items-center gap-2 text-sm font-medium text-slate-700 transition-colors dark:text-slate-200"
              for="id_estimated_credit_value"
            >
              <i class="fa-solid fa-star"></i>
              Estimated credits
            </label>
            <button
              id="estimate-points-btn"
              type="button"
              class="inline-flex items-center gap-2 rounded-lg border border-sky-500 px-3 py-1.5 text-xs font-semibold text-sky-600 transition hover:bg-sky-50 dark:border-sky-400 dark:text-sky-300 dark:hover:bg-sky-500/10"
            >
              <i class="fa-solid fa-wand-magic-sparkles"></i>
              Estimate with AI
            </button>
          </div>
          <div
            class="mt-2 relative rounded-xl border border-slate-200 bg-white focus-within:border-sky-400 focus-within:ring-2 focus-within:ring-sky-200 transition-colors dark:border-slate-700 dark:bg-slate-900/60 dark:focus-within:ring-0"
          >
            {{ form.estimated_credit_value }}
          </div>
          <p
            id="estimate-feedback"
            class="mt-2 text-xs text-slate-500 transition-colors dark:text-slate-400"
          ></p>
          {% if form.estimated_credit_value.errors %}
          <p class="mt-2 text-xs text-rose-500">
            {{ form.estimated_credit_value.errors|striptags }}
          </p>
          {% endif %}
        </div>
        <div class="md:col-span-2">
          <label
            class="inline-flex items-center gap-2 text-sm font-medium text-slate-700 transition-colors dark:text-slate-200"
            for="id_estimated_precious_metal_mass"
          >
            <i class="fa-solid fa-scale-balanced"></i>
            Estimated precious metal mass (g)
          </label>
          <div
            class="mt-2 relative rounded-xl border border-slate-200 bg-white focus-within:border-sky-400 focus-within:ring-2 focus-within:ring-sky-200 transition-colors dark:border-slate-700 dark:bg-slate-900/60 dark:focus-within:ring-0"
          >
            {{ form.estimated_precious_metal_mass }}
          </div>
          {% if form.estimated_precious_metal_mass.errors %}
          <p class="mt-2 text-xs text-rose-500">
            {{ form.estimated_precious_metal_mass.errors|striptags }}
          </p>
          {% endif %}
        </div>
        <div class="md:col-span-2">
          <label
            class="inline-flex items-center gap-2 text-sm font-medium text-slate-700 transition-colors dark:text-slate-200"
            for="id_message_to_facility"
          >
            <i class="fa-solid fa-message"></i>
            Message to facility
          </label>
          <div
            class="mt-2 relative rounded-xl border border-slate-200 bg-white focus-within:border-sky-400 focus-within:ring-2 focus-within:ring-sky-200 transition-colors dark:border-slate-700 dark:bg-slate-900/60 dark:focus-within:ring-0"
          >
            {{ form.message_to_facility }}
          </div>
          {% if form.message_to_facility.errors %}
          <p class="mt-2 text-xs text-rose-500">
            {{ form.message_to_facility.errors|striptags }}
          </p>
          {% endif %}
        </div>
      </div>
      <div class="flex items-center gap-3">
        {{ form.agree_to_guidelines }}
        <label
          for="id_agree_to_guidelines"
          class="inline-flex items-center gap-2 text-sm text-slate-600 transition-colors dark:text-slate-300"
        >
          <i class="fa-solid fa-shield-check text-sky-500"></i>
          I confirm I have wiped personal data and will follow packaging
          instructions.
        </label>
      </div>
      {% if form.non_field_errors %}
      <div
        class="rounded-xl border border-rose-500/40 bg-rose-500/10 px-4 py-3 text-sm text-rose-200"
      >
        {{ form.non_field_errors }}
      </div>
      {% endif %}
      <button
        type="submit"
        class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-sky-600 px-6 py-3 text-sm font-semibold text-white transition hover:bg-sky-500 dark:text-slate-950"
      >
        <i class="fa-solid fa-paper-plane"></i>
        Submit device for review
      </button>
    </form>
  </div>
</section>

<script>
  (function () {
    const getCsrfToken = () => {
      const input = document.querySelector(
        "#device-submission-form input[name=csrfmiddlewaretoken]"
      );
      return input ? input.value : "";
    };

    const form = document.getElementById("device-submission-form");
    const estimateBtn = document.getElementById("estimate-points-btn");
    const creditField = document.getElementById("id_estimated_credit_value");
    const massField = document.getElementById(
      "id_estimated_precious_metal_mass"
    );
    const feedback = document.getElementById("estimate-feedback");

    if (!form || !estimateBtn) {
      return;
    }

    const getSelectedText = (select) => {
      if (!select) return "";
      const option = select.options[select.selectedIndex];
      return option ? option.text : "";
    };

    estimateBtn.addEventListener("click", async (event) => {
      event.preventDefault();
      if (feedback) {
        feedback.textContent = "Estimating credits…";
      }

      const payload = {
        device_name:
          document.getElementById("id_custom_device_name")?.value ||
          getSelectedText(document.getElementById("id_device_model")),
        device_category: getSelectedText(
          document.getElementById("id_device_category")
        ),
        device_type:
          document.getElementById("id_custom_device_type")?.value ||
          getSelectedText(document.getElementById("id_device_category")),
        facility_name: getSelectedText(
          document.getElementById("id_drop_off_facility")
        ),
        user_estimated_mass: document.getElementById(
          "id_estimated_precious_metal_mass"
        )?.value,
        user_notes: document.getElementById("id_message_to_facility")?.value,
        pickup_address: document.getElementById("id_pickup_address")?.value,
      };

      try {
        const response = await fetch('{% url "devices:estimate" %}', {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCsrfToken(),
          },
          body: JSON.stringify(payload),
        });

        const data = await response.json();

        if (!response.ok || !data.success) {
          throw new Error("Unable to fetch AI estimate.");
        }

        if (creditField && data.estimated_credit_value) {
          creditField.value = data.estimated_credit_value;
        }

        if (massField && data.estimated_precious_metal_mass_grams) {
          massField.value = data.estimated_precious_metal_mass_grams;
        }

        if (feedback) {
          feedback.textContent = data.confidence
            ? `AI confidence: ${data.confidence}`
            : "AI estimate applied.";
          feedback.classList.remove("text-rose-500");
        }
      } catch (error) {
        if (feedback) {
          feedback.textContent =
            "Could not estimate credits right now. Try again later.";
          feedback.classList.add("text-rose-500");
        }
      }
    });
  })();
</script>
{% endblock %}
